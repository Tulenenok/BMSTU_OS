# Семафоры

## Введение

**Семафор** - это счетчик, который используется для предоставления доступа к данным, совместно используемым несколькими процессами.

## Процессы и семафоры

Чтобы получить доступ к ресурсу, находящемуся в совместном использовании, процесс должен:

1. **Проверить состояние семафора**, который регулирует доступ к этому ресурсу
2. Если **семафор имеет положительное значение**, процесс **может обратиться к ресурсу**. В этом случае процесс уменьшает значение семафора на 1 (указывая тем самым, что он использовал единицу ресурса)
3. В противном случае, если **семафор имеет значение 0**, **процесс приостанавливается** до тех пор, пока значение семафора не станет > 0. После этого процесс восстановит работу и вернется к шагу 1.

4. **По окончании работы** с ресурсом, доступ к которому регулируется семафором, **значение семафора будет увеличено на 1**.

Для корректной работы семафоров необходимо, чтобы проверка состояния семафора и его уменьшение выполнялись в виде атомарной операции. По этой причине семафоры обычно **реализуются внутри ядра**.

*Атомарная операция — операция, которая либо выполняется целиком, либо не выполняется вовсе*

## Особенности семафоров

1. Семафор - это не просто одиночное неотрицательное значение. Чтобы определить семафор, необходимо определить **набор** из одного или более семафоров. (количество семафоров в наборе задается при создании этого набора)
2. **Создание набора** семафоров (`semget`) **происходит независимо от его инициализации** (`semctl`). Это очень серьезный недостаток, поскольку невозможно атомарно создать новый набор семафоров и инициализировать их значения.
3. Поскольку **семафоры продолжают существовать даже после завершения процессов**, их использующих, необходимо предусматривать в программах алгоритмы освобождения размещенных ранее наборов семафоров. 

## Семафоры в ядре

Каждому набору семафоров ядро ставит в соответствие структуру `semid_ds`

```c
struct semid_ds {
  struct ipc_perm sem_perm;   // Структура прав доступа 
  unsigned short sem_nsems;   // Кол-во семафоров в наборе 
  time_t sem_otime;           // Время последнего вызова semop() 
  time_t sem_ctime;           // Время последнего изменения 
}
```

Каждый из семафоров представлен в наборе анонимной структурой, которая содержит как минимум следующие поля:

```c
struct {
  unsigned short semval;   // Значение семафора 
  pid_t sempid;            // ID процесса, выполнившего посл. операцию
  // Кол-во процессов, ожидающих выполнения условия semval > curval
  unsigned short semncnt;  
  // Кол-во процессов, ожидающих выполнения условия semval == 0
  unsigned short semzcnt;
}
```

Системные пределы, которые имеют отношение к наборам семафоров можно посмотреть в приложении.

## Работа с семафорами

### Semget

Обычно при работе с семафорами прежде всего вызывается функия `semget`, которая возвращает **идентификатор набора семафоров** (или -1 в случае ошибки).

```c
#include <sys/sem.h>

int semget(key_t key, int nsems, int flag);
```

При создании нового набора инициализируются следующие поля структуры `semid_ds`:

1. Структура `ipc_perm` инициализируется, при этом поле `mode` устанавливается в соответствии со значениями битов прав доступа в аргументе `flag`. (конкретные значения см в приложении)
2. В поле sem_otime записывается 0
3. В поле sem_ctime записывается значение текущего времени
4. В поле sem_nsems записывается значение аргумента nsems.

*Замечание*. Если при вызове набор не создается, а открывается существующий, то допускается передать в `nsems` 0. Создание или открытие будет определять параметр `key`. Ключ `IPC_PRIVATE` гарантирует создание новой структуры (но там много тонкостей см. 15.6.1)

### Semctl

С помощью этой функции выполняются операции над набором семафоров.

```c
#include <sys/sem.h>

int semctl(int semid, int semnum, int cmd, ... /* union semun arg */ );

/*
 * Четвертый аргумент функции является необязательным и зависит от
 * выполняемой команды - если он присутствует, то представляет собой
 * объединение semun различных аргументов команд:
 */

union semun {
  int val;                // для SETVAL
  struct semid_ds *buf;   // для IPC_STAT и IPC_SET
  unsigned short *arry;   // для GETALL и SETALL
}

// !!! Четвертый аргумент является объединением, а не указателем
// на объединение
```

Что определяют аргументы здесь?

*  `cmd` определяет одну из 10 операций, которые могут выполняться над набором семафоров
* `semid` - идентификатор набора семафоров
* `semnum` - номер семафора в наборе (нужен для 5 команд)

В случае всех GET-команд кроме GETALL, функция возвращает соответствующее значение вызывающему процессу. Для остальных команд возвращается 0.

|  Команда   | Описание                                                     | Особенности                                                  |
| :--------: | :----------------------------------------------------------- | ------------------------------------------------------------ |
| `IPC_STAT` | Получить структуру `semid_ds`, которая соответствует заданному набору семафоров | Структура будет сохранена  по адресу `arg.buf`               |
| `IPC_SET`  | Установить значения полей `sem_perm.uid`, `sem_perm.gid` и `sem_perm.mode` в соответствии со значениями этих же полей в структуре, на которую укзывает `arg.buf`. | Команда может быть выполнена процессом только в том случае, если его эффективный идентификатор пользователя совпадает со значением `sem_perm.cuid` или `sem_perm.uid` или если процесс обладает привилегиями супер пользователя. |
| `IPC_RMID` | Удалить набор семафоров. Удаление происходит немедленно. Все процессы, которые продолжают использовать набор семафоров, получат код ошибки `EIDRM` при первой же попытке обращения к нему. | Команда может быть выполнена процессом только в том случае, если его эффективный идентификатор пользователя совпадает со значением `sem_perm.cuid` или `sem_perm.uid` или если процесс обладает привилегиями супер пользователя. |
|  `GETVAL`  | Вернуть значение поля `semval` для семафора с номером `semnun`. |                                                              |
|  `SETVAL`  | Установить значение поля `semval` для семафора с номером `semnum`. | Значение определяется в  `arg.val`                           |
|  `GETPID`  | Вернуть значение поля `sempid` для семафора с номером `semnum` |                                                              |
| `GETNCNT`  | Вернуть значение поля `semcnt` для семафора с номером `semnum`. |                                                              |
| `GETZNCNT` | Вернуть значение поля `semzcnt` для семафора с номером `semnum` |                                                              |
|  `GETALL`  | Вернуть значения всех семафоров в наборе.                    | Значения сохраняются в массиве, на который указывает `arg.array` |
|  `SETALL`  | Уставновить значения всех семафоров в наборе.                | Значения берутся из массива, на который указывает `arg.array` |

 

### Semop

Выполнить сразу несколько операций над набором семафоров. 

Функция выполняет все операции атомарно - будут выполнены либо все запрошенные дейстивия, либо ни одно их них.

```c
#include <sys/sem.h>

int semop(int semid, struct sembuf semoparray[], size_t nops);

// Возвращает 0 в случае успеха, -1 в случае ошибки
```

Значения аргументов:

* `nops` - определяет количество операция (элементов) в массиве

* `semoparray` - массив указателей на операции с семафорами, каждая из которых представлена в виде структуры `sembuf`

  ```c
  struct sembuf {
    unsigned short sem_num;    // Кол-во семафоров в наборе 
    short sem_op;              // Операция (<0, 0 или >0)
    short sem_flg;             // IPC_NOWAIT, SEM_UNDO
  }
  ```

  Про `sem_op`:

  1. `sem_op` > 0 - случай, когда процесс освобождает занятые ресурсы. 

     > Значение `sem_op` добавляетя к значению семафора. Если указан флаг `SEM_UNDO`, значение также вычитается из значения корректировки процесса

  2. `sem_op` < 0 - процесс желает получить ресурс, доступ к которому регулируется семафором.

     > Если значение семафора >= абсолютному значению `sem_op`, абсолютное значение вычитается из значения семафора. Если указан флаг `SEM_UNDO`, значение также прибавляется к величине корректировки процесса.
     >
     > Если значение семафора <, то есть ресурс недоступен, то работает все также, как и ниже для семафора > 0, только использовать мы будем `semncnt`,  а не `semzcnt`. 
     >
     > И плюс первое из трех условий будет выглядет следующим образом:
     >
     > * Значение семафора стало >= абсолютному значению `sem_op`. Значение `semcnt` для этого семафора уменьшается и абсолютное значение `sem_op` вычитается из значения семафора. Если указан флаг `SEM_UNDO`, значение также прибавляется к величине корректировки процесса.

  3. `sem_op` = 0 - процесс желает дождатся момента, когда значение семафора достигнет 0.

     > Если значение семафора уже = 0, функция сразу вернет управление.
     >
     > Если значение семафора > 0, тогда 
     >
     > * если указан флаг `IPC_NOWAIT` - функция `semop` возващает управление с кодом ошибки `EAGAIN`
     > * если флаг не указан, то для данного семафора увеличивается значение `semzcnt` и выполнение вызывающего процесса приостаналивается до тех пор, пока не будет соблюдено одно из следующих условий:
     >   * Значение семафора станет = 0. В этом случае значение `semzcnt` уменьшается
     >   * Семафор удаляется из системы. В этом случае функция `semop` вернет признак ошибки с кодом `EIDRM`
     >   * Процессом был перехвачен сигнал и обработчик сигнала вернул управление. Тогда значение `semzcnt` уменьшается и функция  `semop`  вернет признак ошибки с кодом `EINTR`.

## Корректировка семафора по завершении

Проблема: завершение процесса в то время, когда он захватил какие-либо ресурсы посредством семафора.

Решение: всякий раз, когда мы делаем операцию над семафором, устанавливаем флаг `SEM_UNDO`. 

В этом случае ядро будет запомнать, как много ресурсов было захвачено процессом с помощью конкретного семафора. Когда процесс завершается, добровольно или принудительно, ядро проверяет, имеет ли процесс какие-либо невыполненныые корректировки семафоров и, если таковые имеются, корректирует значения соотсвтетствующих семафоров.

## Приложение

### Системные пределы семафоров

<img width="632" alt="image-20221113150657096" src="https://user-images.githubusercontent.com/78147880/201524010-bce0e4aa-4da9-4509-9b50-6b0aa381e964.png">

### Про структуру ipc_perm

```c
struct ipc_perm {
  uid_t uid;  // Эффективный идентификатор пользователя владельца
  gid_t gid;  // Эффективный идентификатор группы владельца
  uid_t cuid; // Эффективный идентификатор пользователя создателя
  gid_t cgid; // Эффективный идентификатор группы создателя
  
  mode_t mode; // Режим доступа
  ...
}
```

Значение поля `mode`:

<img width="600" alt="image-20221113151512563" src="https://user-images.githubusercontent.com/78147880/201524015-008e2de8-2daf-47b2-ab96-1b6231c1ced8.png">
