# Процессы-демоны

## Введение

Демоны - это долгоживущие процессы. Зачастую они запускаются во время загрузки системы и завершают работу вместе с ней. Так как они не имеют управляющего терминала, говорят, что они работают в фоновом режиме

## Характеристики демонов

Выведем информацию о процессах в системе:

```bash
ps -axj

# -a -- вывод процессов, которыми владеют другие пользователи
# -x -- вывод процессов, не имеющих управляющего терминала
# -j -- вывод доп. сведений, имеющих отношение к заданиям (
# идентификатор сессии, идентификатор группы процессов, управляющего терминала
# идентификатора группы процессов терминала )
```

Получим примерно такую картину:

|           PPID            |     PID     |        PGID         |    SID    |      TTY      |             TPGID             |       UID       |     COMAND     |
| :-----------------------: | :---------: | :-----------------: | :-------: | :-----------: | :---------------------------: | :-------------: | :------------: |
|             0             |      1      |          0          |     0     |       ?       |              -1               |        0        |      Init      |
|             1             |      2      |          1          |     1     |       ?       |              -1               |        0        |   [keventd]    |
|             1             |      3      |          1          |     1     |       ?       |              -1               |        0        |    [kapmd]     |
|            ...            |     ...     |         ...         |    ...    |      ...      |              ...              |       ...       |      ...       |
| ID родительского процесса | ID процесса | ID группы процессов | ID сессии | Имя терминала | ID группы процессов терминала | ID пользователя | Строка команды |

*ID - Идентификатор*

```
Здесь идентификатор сессии - идентификатор процесса лидера сессии. 
Для систем, основанных на BSD, будет выведен адрес структуры session, соотв. группе
процессов, которой принадлежит данных процесс.
```

Список процессов может разниться от одной ОС к другой. Важны здесь следующие моменты:

1. `PPID = 0` -> процесс был запущен ядром в процессе загрузки системы.(Исключение - процесс init, это команда уровня пользователя, которая запускается ядром во время загрузки.)

   ```
   Процессы ядра - особые процессы, существующие все время, пока работает система. 
   Обладают привилегиями суперпользователя и не имеют управляющего терминала и строки команды.
   ```

2. `PID = 1` -> обычно это процесс init. Это системный демон, который отвечает за запуск различных системных служб на различных уровнях загрузки. 

3. `UID = 0` -> большинство демонов управляют привилегиями суперпользователя.

4. `TTY = ? (и TPGID = -1)` -> демоны не имеют управляющего терминала

   ```
   Демоны ядра запускаются без управляющего терминала.
   Отсутствие упр. терминала у демонов пользовательского уровня - вероятно, результат вызова функции setsid.
   
   Все демоны пользовательского уровня являются лидерами групп и лидерами сессий. 
   (они являются единственными процессами в своих группах процессов и сессиях)
   ```

5. Родителем большинства является `init`. 

*Краткую справку по некоторым демонам можно найти в приложении*

## Правила программирования демонов

1. Нужно вызвать функцию `umask`, чтобы сбросит маску режима создания файлов в значение 0.

   Маска режима создания файлов, наследуемая от запускающего процесса, может маскировать некоторые биты прав доступа. (если вдруг демн будет создавать файлы, то может потребоваться установка определенных битов прав доступа).

2. Вызвать функцию `fork` и завершить родительский процесс.

   Зачем?

   1. Если демон был запущен, как обычная команда оболочки, то завершив родительский процесс, мы заставим командную оболочку думать, что команда была выполнена.
   2. Дочерний процесс унаследует идентификатор группы процессов у родителя, но получит своей PID => дочерний процесс не будет являтся лидером группы, а это необходимое условие для вызова `setsid`

3. Создать новую сессию, обратившись к функции `setsid`

   При этом процесс становится лидером новой сессии, лидером новой группы и лишается управляющего терминала

4. Сделать корневой каталог текущим рабочим каталогом

   Текущий рабочий каталог может находится на смонтированной файловой системе. Если там будет демон, то ее невозможно будет отмонтировать.

5. Закрыть все ненужные файловые дескрипторы.

   Это предотвращает удержание в открытом состоянии некоторых дескрипторов. 

   C помощью функции `getlimit` можно определить максимально возможный номер дескриптора и закрыть все дескрипторы вплоть до этого номера.

6. Некоторые демоны открывают файловые дескрипторы с номерами 0, 1, 2 на устройстве /dev/null - чтобы попытки стандартного ввода или вывода не оказывали никакого влияния.  (Демон не связан ни с одним терминальным устройством => он не может взаимодействовать с пользователем в интерактивном режиме)

## Приложение

**Некоторые демоны из Linux**:

1. `keventd` - предоставляет контекст процесса для запуска задач из очереди планировщика.
2. `kapmd` - обеспечивает поддержку расширенного управления питанием
3. `kswapd` - демон выгрузки страниц (поддерживает подсистему виртуальной памяти, в фоновом режиме записывая на диск страницы, измененные со времени их чтения с диска, благодаря чему они могут быть использованы снова)
4. `bdflush` и `kupdated` - сбрасывание кэшированных данных на диск (первый сбрасывает, когда объем свободной памяти уменьшается до определенного уровня, второй через регулярные интервалы времени)
5. `portmap` - осуществляет преобразование номеров программ RPC в номера сетевых портов.
6. `syslogd` - может использоваться программами для вывода системных сообщений в журнал просмотра оператором.
7. `inetd` - ожидает поступления из сети запросов к различным сететвым серверам.
8. `nfsd`, `lockd`, `rpciod` - обеспечивают поддержку сетевой файловой системы
9. `cron` - производит запуск команд в определенное время.
10. `cupsd` - сервер печати, обслуживает запросы к принтеру.
